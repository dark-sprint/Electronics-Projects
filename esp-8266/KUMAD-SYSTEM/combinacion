#include <ESP8266WiFi.h>
#include <ESP8266Ping.h>
#include <ESP_Mail_Client.h>

// ===== CONFIGURACIÓN RED =====
const char* ssid = "TU_WIFI";
const char* password = "TU_PASSWORD";

// ===== CONFIGURACIÓN CORREO =====
#define SMTP_HOST "smtp.gmail.com"
#define SMTP_PORT 587

#define AUTHOR_EMAIL "TU_CORREO@gmail.com"
#define AUTHOR_PASSWORD "TU_APP_PASSWORD"
#define RECIPIENT_EMAIL "DESTINO@gmail.com"

// ===== ARRAY DE HOSTS =====
struct Host {
  const char* ip;
  const char* name;
  bool isUp;
};

Host hosts[] = {
  {"192.168.1.1", "Router", true},
  {"192.168.1.100", "Servidor NAS", true}
};
const int numHosts = sizeof(hosts)/sizeof(hosts[0]);

// ===== PIN DEL PIR =====
const int pirPin = D2; // Conectado al OUT del HC-SR501 mini
unsigned long lastMotionEmail = 0; // Para control de 10 segundos entre correos
const unsigned long motionDelay = 10000; // 10 segundos

// ===== OBJETO SMTP =====
SMTPSession smtp;

// ===== FUNCIONES =====
void sendEmail(const char* subject, const char* message) {
  SMTP_Message mail;
  mail.sender.name = "ESP8266 Watcher";
  mail.sender.email = AUTHOR_EMAIL;
  mail.subject = subject;
  mail.addRecipient("Admin", RECIPIENT_EMAIL);
  mail.text.content = message;

  ESP_Mail_Session session;
  session.server.host_name = SMTP_HOST;
  session.server.port = SMTP_PORT;
  session.login.email = AUTHOR_EMAIL;
  session.login.password = AUTHOR_PASSWORD;
  session.login.user_domain = "";

  if (!smtp.connect(&session)) {
    Serial.println("Error conectando a SMTP");
    return;
  }

  if (!MailClient.sendMail(&smtp, &mail)) {
    Serial.println("Error enviando correo: " + smtp.errorReason());
  } else {
    Serial.println("Correo enviado correctamente.");
  }

  smtp.closeSession();
}

// ===== SETUP =====
void setup() {
  Serial.begin(115200);

  // Cambiar MAC tipo Acer (opcional)
  uint8_t mac[6] = {0x00, 0x1B, 0x2F, 0xAA, 0xBB, 0xCC};
  WiFi.macAddress(mac);

  pinMode(pirPin, INPUT);

  WiFi.begin(ssid, password);
  Serial.print("Conectando a WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");
}

// ===== LOOP PRINCIPAL =====
void loop() {
  // --- MONITOREO DE HOSTS ---
  for (int i = 0; i < numHosts; i++) {
    bool pingResult = Ping.ping(hosts[i].ip, 1); // 1 intento
    if (pingResult != hosts[i].isUp) {
      hosts[i].isUp = pingResult;

      char subject[64];
      char message[128];

      if (pingResult) {
        snprintf(subject, sizeof(subject), "✅ %s UP", hosts[i].name);
        snprintf(message, sizeof(message), "%s (%s) está nuevamente UP.", hosts[i].name, hosts[i].ip);
        Serial.println(message);
      } else {
        snprintf(subject, sizeof(subject), "❌ %s DOWN", hosts[i].name);
        snprintf(message, sizeof(message), "%s (%s) está DOWN.", hosts[i].name, hosts[i].ip);
        Serial.println(message);
      }

      sendEmail(subject, message);
    }
  }

  // --- DETECCIÓN DE MOVIMIENTO ---
  bool motion = digitalRead(pirPin) == HIGH;
  unsigned long currentMillis = millis();

  if (motion && currentMillis - lastMotionEmail >= motionDelay) {
    Serial.println("¡Movimiento detectado!");
    sendEmail("🚨 Movimiento detectado", "Se ha detectado movimiento en la zona monitoreada.");
    lastMotionEmail = currentMillis;

    // Espera mientras sigue detectando movimiento
    while(digitalRead(pirPin) == HIGH){
      delay(100);
    }
  }

  delay(500); // Pequeña pausa para rebotes
}
